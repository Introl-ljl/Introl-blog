---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import ProjectHeatmap from "../../components/ProjectHeatmap.astro";
import ProjectTimeline from "../../components/ProjectTimeline.astro";
import StatusBadge from "../../components/StatusBadge.astro";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
	const projects = await getCollection("projects");
	return projects.map((project) => ({
		params: { slug: project.slug },
		props: { project },
	}));
}

const { project } = Astro.props;
const { Content } = await project.render();

// 调试项目数据
console.log('项目数据:', project.data);
console.log('项目timeline:', project.data.timeline);

// 获取与该项目关联的文章
const posts = await getCollection("posts");
const relatedPosts = posts
	.filter((post) => (post.data.project === project.slug || post.data.project === project.data.title) && !post.data.draft)
	.sort((a, b) => b.data.published.getTime() - a.data.published.getTime());

// 格式化日期
const formatDate = (date: Date) => {
	return new Intl.DateTimeFormat("zh-CN", {
		year: "numeric",
		month: "long",
		day: "numeric",
	}).format(date);
};

// 获取状态颜色
const getStatusColor = (status: string) => {
	const colors = {
		进行中: "status-in-progress",
		已完成: "status-completed",
		暂停: "status-paused",
		计划中: "status-planned",
	};
	return colors[status as keyof typeof colors] || colors["进行中"];
};
---

<Layout title={project.data.title} description={project.data.description}>
  <MainGridLayout>
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- 项目概览卡片 -->
      <div class="card-base hover:shadow-lg transition-all duration-300 overflow-hidden mb-8">
        <!-- 项目基本信息 -->
        <header class="p-8 text-center border-b border-[var(--line-divider)]">
          <div class="mb-6">
            <h1 class="text-4xl font-bold text-90 mb-3">
              {project.data.title}
            </h1>
            <p class="text-lg text-75 mb-4">
              {project.data.description}
            </p>
            <StatusBadge status={project.data.status || '进行中'} size="lg" />
          </div>

        </header>

      <!-- 时间线和热力图 -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-0">
        <!-- 项目时间线 (主要内容，占2/3) -->
        <div class="lg:col-span-2 p-8 lg:border-r border-[var(--line-divider)] border-b lg:border-b-0">
          <h2 class="text-2xl font-semibold text-90 mb-6 flex items-center">
            <Icon name="material-symbols:timeline" class="w-6 h-6 mr-3 text-[var(--primary)]" />
            项目时间线
          </h2>
          <ProjectTimeline project={project} relatedPosts={relatedPosts} />
        </div>

        <!-- 项目热力图 (右侧，占1/3) -->
        <div class="lg:col-span-1 p-8 lg:self-start">
          <!-- 项目概述 -->
          <div class="mb-8">
            <h2 class="text-xl font-semibold text-90 mb-4">项目概述</h2>
            <div class="text-sm text-75 leading-relaxed space-y-3">
              <p>
                <strong>状态：</strong>
                <span class="ml-1">
                  <StatusBadge status={project.data.status} size="sm" />
                </span>
              </p>
              <p><strong>开始时间：</strong>{new Intl.DateTimeFormat('zh-CN').format(new Date(project.data.startDate))}</p>
              <p><strong>最后更新：</strong>{new Intl.DateTimeFormat('zh-CN').format(new Date(project.data.lastUpdate))}</p>
              <p><strong>项目描述：</strong>{project.data.description}</p>
            </div>
          </div>

          <!-- 活动热力图 -->
          <div class="mb-8">
            <h2 class="text-xl font-semibold text-90 mb-6 flex items-center">
              <Icon name="material-symbols:heat-pump-balance" class="w-6 h-6 mr-3 text-[var(--primary)]" />
              活动热力图
            </h2>
            <ProjectHeatmap project={project} relatedPosts={relatedPosts} layout="horizontal" />
          </div>

          <!-- 项目数据统计 -->
          <div>
            <h3 class="text-lg font-semibold text-90 mb-4">项目数据</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-[var(--btn-regular-bg)] p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-[var(--primary)] mb-1">{project.data.progress}%</div>
                <div class="text-sm text-75">完成进度</div>
              </div>
              <div class="bg-[var(--btn-regular-bg)] p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-[var(--primary)] mb-1">{relatedPosts.length}</div>
                <div class="text-sm text-75">相关文章</div>
              </div>
              <div class="bg-[var(--btn-regular-bg)] p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-[var(--primary)] mb-1">{project.data.tags?.length || 0}</div>
                <div class="text-sm text-75">技术标签</div>
              </div>
              <div class="bg-[var(--btn-regular-bg)] p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-[var(--primary)] mb-1">
                  {Math.ceil((new Date().getTime() - new Date(project.data.startDate).getTime()) / (1000 * 60 * 60 * 24))}
                </div>
                <div class="text-sm text-75">开发天数</div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- 返回按钮 -->
      <div class="p-8 text-center border-t border-[var(--line-divider)]">
        <a
          href="/projects/"
          class="inline-flex items-center px-6 py-3 bg-[var(--btn-regular-bg)] text-[var(--btn-content)] rounded-lg hover:bg-[var(--btn-regular-bg-hover)] transition-colors"
        >
          <Icon name="material-symbols:arrow-back" class="w-4 h-4 mr-2" />
          返回项目列表
        </a>
      </div>
      </div>
    </div>
  </MainGridLayout>
</Layout>

<!-- Prose styles moved to global CSS (src/styles/main.css) -->
