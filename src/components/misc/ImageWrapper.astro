---
import { url } from "../../utils/url-utils";
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro:assets";

interface Props {
  id?: string;
  src: string;
  class?: string;
  alt?: string;
  position?: string;
  basePath?: string; // 可选：相对 src/ 的前缀
}

const { id, src, alt, position = "center", basePath = "" } = Astro.props as Props;
const className = (Astro.props as any).class as string | undefined;

const isRemote = src.startsWith("http") || src.startsWith("https") || src.startsWith("data:");
const isAbsolutePublic = src.startsWith("/");

// 本地资源：尝试使用 astro:assets 动态导入（支持 src/assets 与 /assets）
let img: ImageMetadata | undefined;
if (!isRemote) {
  const files = import.meta.glob<ImageMetadata>("../../**/*", { import: "default" });

  const strip = (p: string) => p.replace(/^\/+/, "").replace(/^src\//, "");
  const body = strip(String(src || "").trim().replace(/\\/g, "/"));
  const base = strip(String(basePath || ""));

  const candidates: string[] = [];
  // 原始相对路径
  candidates.push(body);
  // basePath + body
  if (base) candidates.push(`${base}/${body}`.replace(/\/+/g, "/"));
  // /assets 或 assets 路径统一映射到 src/assets
  const altBody = body.replace(/^assets\//, "").replace(/^\/+/, "");
  candidates.push(`assets/${altBody}`);

  for (const cand of candidates) {
    const key = `../../${cand}`.replace(/\/+/g, "/");
    if (files[key]) {
      // @ts-ignore
      img = await files[key]();
      break;
    }
  }
}

const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
const containerClass = [className, "overflow-hidden relative"].filter(Boolean).join(" ");
---
<div id={id} class={containerClass}>
  <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>
  {isRemote ? (
    <img src={src} alt={alt || ""} class={imageClass} style={imageStyle} />
  ) : img ? (
    <Image src={img} alt={alt || ""} class={imageClass} style={imageStyle} />
  ) : (
    <img src={isAbsolutePublic ? url(src) : url(`/${src}`)} alt={alt || ""} class={imageClass} style={imageStyle} />
  )}
</div>
