---
import path from "node:path";

interface Props {
    id?: string;
    src: string;
    class?: string;
    alt?: string;
    position?: string;
    // 可选：为相对路径提供一个基础前缀（相对 src/ 根目录），默认不加前缀
    basePath?: string;
}

import { Image } from "astro:assets";
import { url } from "../../utils/url-utils";

const { id, src, alt, position = "center", basePath = "" } = Astro.props;
const className = Astro.props.class;

// 远程/内联资源直接用 <img>
const isRemote = (
    src.startsWith("http") ||
    src.startsWith("https") ||
    src.startsWith("data:")
);

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
let resolvedLocalKey = "";
if (!isRemote) {
    const files = import.meta.glob<ImageMetadata>("../../**/*", { import: "default" });

    // 归一化传入路径，尽量匹配 src/ 根下的真实文件
    const raw = String(src || "").trim().replace(/\\/g, "/");

    // 去掉可能的前缀与开头斜杠
    const stripPrefixes = (p: string) => p
        .replace(/^\/+/, "")      // 去掉开头 '/'
        .replace(/^src\//, "");   // 去掉开头的 'src/'

    const base = stripPrefixes(basePath || "");
    const body = stripPrefixes(raw);

    const candidates = [
        body,
        base ? `${base}/${body}`.replace(/\/+/g, "/") : body,
    ];

    // 生成候选键并查找
    for (const cand of candidates) {
        const key = `../../${cand}`.replace(/\/+/g, "/");
        if (files[key]) {
            resolvedLocalKey = key;
            // @ts-ignore - dynamic import type
            img = await files[key]();
            break;
        }
    }

    if (!img) {
        // 进一步尝试把 '/assets/...' 映射到 'assets/...'
        const altBody = body.replace(/^assets\//, "").replace(/^\/+/, "");
        const altKey = `../../assets/${altBody}`.replace(/\/+/g, "/");
        if (files[altKey]) {
            resolvedLocalKey = altKey;
            // @ts-ignore
            img = await files[altKey]();
        }
    }

    if (!img) {
        console.error(`\n[ERROR] Image not found. Tried: ${[...new Set([
            `../../${body}`,
            base ? `../../${base}/${body}` : "",
            `../../assets/${body.replace(/^assets\//, "").replace(/^\/+/, "")}`
        ].filter(Boolean))].join(", ")}`);
    }
}

const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
---
<div id={id} class:list={[className, 'overflow-hidden relative']}>
    <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>
    {!isRemote && img && <Image src={img} alt={alt || ""} class={imageClass} style={imageStyle}/>}
    {(!img && !isRemote) && (
        /* 本地未匹配到文件时，退化为直接使用传入路径（支持 public/ 下资源或绝对路径），并应用 base url */
        <img src={url(src)} alt={alt || ""} class={imageClass} style={imageStyle}/>
    )}
    {isRemote && (
        <img src={src} alt={alt || ""} class={imageClass} style={imageStyle}/>
    )}
</div>
