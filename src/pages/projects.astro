---
import { getCollection } from "astro:content";
import MainGridLayout from "../layouts/MainGridLayout.astro";

import ProjectCard from "../components/ProjectCard.astro";
import ProjectHeatmap from "../components/ProjectHeatmap.astro";
import ProjectTimeline from "../components/ProjectTimeline.astro";
import StatusBadge from "../components/StatusBadge.astro";
import ProgressBar from "../components/ProgressBar.astro";
import { Icon } from "astro-icon/components";

const projects = await getCollection("projects");
const posts = await getCollection("posts");

// 处理项目数据，添加默认分类
const processedProjects = projects.map(project => ({
  ...project,
  data: {
    ...project.data,
    category: project.data.category || '其他',
    tags: project.data.tags || []
  }
}));

// 按项目分组文章
const postsByProject = posts.reduce((acc, post) => {
  if (post.data.project && !post.data.draft) {
    const projectName = post.data.project;
    if (!acc[projectName]) {
      acc[projectName] = [];
    }
    acc[projectName].push(post);
  }
  return acc;
}, {} as Record<string, typeof posts>);

// 为每个项目添加关联文章
const projectsWithPosts = processedProjects.map(project => ({
  ...project,
  relatedPosts: postsByProject[project.data.title] || []
}));

// 按分类分组项目
const projectsByCategory = projectsWithPosts.reduce((acc: any, project: any) => {
  const category = project.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(project);
  return acc;
}, {});

// 获取所有分类
const categories = Object.keys(projectsByCategory);

// 按年份分组项目
const projectsByYear = projectsWithPosts.reduce((acc: any, project: any) => {
  const year = new Date(project.data.lastUpdate).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(project);
  return acc;
}, {});

// 获取所有年份并排序
const years = Object.keys(projectsByYear).sort((a, b) => Number.parseInt(b) - Number.parseInt(a));

// 获取所有标签
const allTags = [...new Set(projectsWithPosts.flatMap((project: any) => project.data.tags || []))];

// 格式化日期
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

// 获取状态颜色
const getStatusColor = (status: string) => {
  const colors = {
    '进行中': 'status-in-progress',
    '已完成': 'status-completed',
    '暂停': 'status-paused',
    '计划中': 'status-planned',
    '即将完成': 'status-nearly-done'
  };
  return colors[status as keyof typeof colors] || colors['计划中'];
};
---

<MainGridLayout title="项目展示" description="探索我的技术项目，从概念到实现的完整旅程">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- 页面标题 -->
      <header class="text-center mb-12">
        <h1 class="text-4xl font-bold text-90 mb-4">
          项目展示
        </h1>
        <p class="text-lg text-75 max-w-2xl mx-auto">
          探索我的技术项目，从概念到实现的完整旅程
        </p>
      </header>

      <!-- 项目展示 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {projectsWithPosts.map((project: any) => (
          <div class="card-base hover:shadow-lg transition-all duration-300 overflow-hidden">
            <div class="p-6">
              <div class="flex items-center gap-3 mb-4">
                <h3 class="text-xl font-bold text-90 flex-1">
                  <a href={`/projects/${project.slug}/`} class="hover:text-[var(--primary)] transition-colors">
                    {project.data.title}
                  </a>
                </h3>
                <StatusBadge status={project.data.status} />
              </div>

              <p class="text-75 mb-4 leading-relaxed">
                {project.data.description}
              </p>

              <div class="flex items-center justify-between text-sm text-60">
                <span>{new Intl.DateTimeFormat('zh-CN').format(new Date(project.data.lastUpdate))}</span>
                <span>{project.data.progress}% 完成</span>
              </div>

              <div class="mt-4 pt-4 border-t border-[var(--line-divider)]">
                <a
                  href={`/projects/${project.slug}/`}
                  class="inline-flex items-center text-sm text-[var(--primary)] hover:text-[var(--primary)]/80 transition-colors"
                >
                  查看详情
                  <Icon name="material-symbols:arrow-forward" class="w-4 h-4 ml-1" />
                </a>
              </div>
            </div>
          </div>
        ))}
      </div>

    </div>
  </MainGridLayout>


